name: Update Profile Stats

on:
  # Run daily at 2 AM UTC
  schedule:
    - cron: "0 2 * * *"

  # Allow manual trigger
  workflow_dispatch:

  # Run on pushes to main branch (only if script.py or config.toml changes)
  push:
    branches: [main]
    paths:
      - "script.py"
      - "config.toml"
      - ".github/workflows/update-stats.yml"

jobs:
  update-stats:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.11"
          cache: "pip"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install requests tomli python-dotenv google-generativeai pytz

      - name: Validate configuration
        run: |
          python -c "import tomli; tomli.load(open('config.toml', 'rb'))"
          echo "‚úÖ Configuration file is valid"

      - name: Run profile stats script
        env:
          GITHUB_TOKEN: ${{ secrets.GIT_TOKEN }}
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        run: |
          python script.py
          echo "‚úÖ Script executed successfully"

      - name: Check for changes
        id: verify-changed-files
        run: |
          if [ -f "PROFILE_README.md" ]; then
            echo "profile_readme_exists=true" >> $GITHUB_OUTPUT
            if [ -n "$(git status --porcelain PROFILE_README.md)" ]; then
              echo "changes_detected=true" >> $GITHUB_OUTPUT
              echo "‚úÖ Changes detected in PROFILE_README.md"
            else
              echo "changes_detected=false" >> $GITHUB_OUTPUT
              echo "‚ÑπÔ∏è No changes detected"
            fi
          else
            echo "profile_readme_exists=false" >> $GITHUB_OUTPUT
            echo "‚ùå PROFILE_README.md not found"
            exit 1
          fi

      - name: Commit and push updated files
        if: steps.verify-changed-files.outputs.changes_detected == 'true'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git config --local user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"

          # Copy PROFILE_README.md to README.md
          cp PROFILE_README.md README.md

          # Add files
          git add PROFILE_README.md README.md

          # Commit with timestamp
          git commit -m "ü§ñ Update profile stats - $(date -u '+%Y-%m-%d %H:%M UTC')"

          # Push changes
          git push
          echo "‚úÖ Changes committed and pushed successfully"

      - name: No changes to commit
        if: steps.verify-changed-files.outputs.changes_detected == 'false'
        run: echo "‚ÑπÔ∏è No changes detected, skipping commit"
