# ü§ñ Automatic GitHub Profile Stats Generator
#
# üìã SETUP INSTRUCTIONS FOR NEW USERS:
# 1. Copy this workflow file to: .github/workflows/update-stats.yml
# 2. Go to your repository Settings > Secrets and variables > Actions
# 3. Add these secrets:
#    - GITHUB_TOKEN: Your GitHub Personal Access Token (with repo permissions)
#    - GEMINI_API_KEY: Your Google Gemini API key for code analysis
# 4. That's it! The workflow will automatically download the latest script and run daily
#
# üîß CUSTOMIZATION (optional):
# - Edit the cron schedule below to change when it runs
# - The script will automatically use your GitHub username
# - Config is downloaded automatically and customized for your account

name: Update Profile Stats

on:
  # Run daily at 2 AM UTC (customize this schedule as needed)
  schedule:
    - cron: "0 2 * * *"

  # Allow manual trigger (click "Run workflow" in Actions tab)
  workflow_dispatch:

  # Run on pushes to main branch (only if workflow changes)
  push:
    branches: [main]
    paths:
      - ".github/workflows/update-stats.yml"

jobs:
  update-stats:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.11"

      - name: Download latest script and config
        run: |
          echo "üì• Downloading latest script from repository..."
          if curl -fsSL https://raw.githubusercontent.com/alessandrobrunoh/update-profile-stats-script/refs/heads/main/script.py -o script.py; then
            echo "‚úÖ Script downloaded successfully"
          else
            echo "‚ùå Failed to download script"
            exit 1
          fi

          echo "üì• Downloading default configuration..."
          if curl -fsSL https://raw.githubusercontent.com/alessandrobrunoh/update-profile-stats-script/refs/heads/main/config.toml -o config.toml; then
            echo "‚úÖ Configuration downloaded successfully"
          else
            echo "‚ùå Failed to download configuration"
            exit 1
          fi

      - name: Install required dependencies
        run: |
          echo "üì¶ Installing required dependencies..."
          python -m pip install --upgrade pip
          pip install tomli
          echo "‚úÖ Dependencies installed"

      - name: Get repository owner username
        id: get-username
        run: |
          USERNAME="${{ github.repository_owner }}"
          if [ -z "$USERNAME" ]; then
            echo "‚ùå Could not detect repository owner"
            exit 1
          fi
          echo "username=$USERNAME" >> $GITHUB_OUTPUT
          echo "üîç Detected repository owner: $USERNAME"

      - name: Update config with repository owner
        run: |
          echo "‚öôÔ∏è Updating configuration with repository owner..."
          cat > update_config.py << 'EOF'
          import re

          # Read the config file
          with open('config.toml', 'r') as f:
              content = f.read()

          # Replace the username
          new_content = re.sub(
              r'username = "alessandrobrunoh"',
              'username = "${{ steps.get-username.outputs.username }}"',
              content
          )

          # Write back the config file
          with open('config.toml', 'w') as f:
              f.write(new_content)

          print("Configuration updated successfully")
          EOF

          if python update_config.py; then
            echo "‚úÖ Configuration updated"
          else
            echo "‚ùå Failed to update configuration"
            exit 1
          fi
          rm -f update_config.py

      - name: Validate configuration
        run: |
          echo "üîç Validating configuration..."
          cat > validate_config.py << 'EOF'
          import tomli

          try:
              with open('config.toml', 'rb') as f:
                  config = tomli.load(f)
              print('‚úÖ Configuration file is valid')
              print(f'üìã Username: {config["github"]["username"]}')
              print(f'üìã Model: {config["gemini"]["model"]}')
          except Exception as e:
              print(f'‚ùå Configuration validation failed: {e}')
              exit(1)
          EOF

          if python validate_config.py; then
            echo "‚úÖ Configuration validation passed"
          else
            echo "‚ùå Configuration validation failed"
            exit 1
          fi
          rm -f validate_config.py

      - name: Run profile stats script
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          CI: true
        run: |
          echo "üöÄ Running profile stats script..."
          echo "üîë Using GITHUB_TOKEN and GEMINI_API_KEY from repository secrets"
          echo "üë§ Repository owner: ${{ github.repository_owner }}"

          if [ -z "$GITHUB_TOKEN" ]; then
            echo "‚ùå GITHUB_TOKEN secret is not set"
            exit 1
          fi

          if [ -z "$GEMINI_API_KEY" ]; then
            echo "‚ùå GEMINI_API_KEY secret is not set"
            exit 1
          fi

          # Run script with retry logic for package installation
          for attempt in 1 2 3; do
            echo "üîÑ Attempt $attempt/3"
            if python script.py; then
              echo "‚úÖ Script executed successfully"
              break
            else
              if [ $attempt -eq 3 ]; then
                echo "‚ùå Script execution failed after 3 attempts"
                exit 1
              else
                echo "‚ö†Ô∏è Script failed, retrying in 10 seconds..."
                sleep 10
              fi
            fi
          done

      - name: Check for changes
        id: verify-changed-files
        run: |
          if [ -f "PROFILE_README.md" ]; then
            echo "profile_readme_exists=true" >> $GITHUB_OUTPUT
            if [ -n "$(git status --porcelain PROFILE_README.md README.md 2>/dev/null)" ]; then
              echo "changes_detected=true" >> $GITHUB_OUTPUT
              echo "‚úÖ Changes detected in generated files"
            else
              echo "changes_detected=false" >> $GITHUB_OUTPUT
              echo "‚ÑπÔ∏è No changes detected"
            fi
          else
            echo "profile_readme_exists=false" >> $GITHUB_OUTPUT
            echo "‚ùå PROFILE_README.md not found"
            exit 1
          fi

      - name: Commit and push updated files
        if: steps.verify-changed-files.outputs.changes_detected == 'true'
        run: |
          echo "üìù Configuring git..."
          git config --local user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"

          echo "Stashing changes to avoid conflicts..."
          git stash

          echo "Pulling latest changes from remote..."
          git pull --rebase

          echo "Applying stashed changes..."
          git stash pop

          echo "Copying generated profile to README..."
          cp PROFILE_README.md README.md

          echo "Adding all changes to git..."
          git add PROFILE_README.md README.md config.toml

          echo "Committing changes..."
          git commit -m "ü§ñ Update profile stats - $(date -u '+%Y-%m-%d %H:%M UTC')" || {
            echo "No changes to commit."
            exit 0
          }

          echo "Pushing changes to remote..."
          git push

      - name: No changes to commit
        if: steps.verify-changed-files.outputs.changes_detected == 'false'
        run: echo "‚ÑπÔ∏è No changes detected, skipping commit"

      - name: Cleanup downloaded files
        if: always()
        run: |
          echo "üßπ Cleaning up downloaded files..."
          rm -f script.py config.toml update_config.py validate_config.py
          echo "‚úÖ Cleanup completed"
